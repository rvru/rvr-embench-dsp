/**
    Elliptic filter testbench.

    Reference: (https://en.wikipedia.org/wiki/Elliptic_filter)

    @file elliptic_tb.c
    @author
    @email
    @date
*/

#include "elliptic.h"
#include "util.h"

/************************************************
 *  constants
 ***********************************************/

#define PADDING 5
#define DATA_LENGTH 256


/************************************************
 *  main
 ***********************************************/

int main(void)
{
    // filter coefficients
    float a[] = { 1, 1.6141607939064317, -0.9031492413866293, 1, 1.6789212089700198, -0.8298796467544193, 1, 1.7402021652716963, -0.7739286551279295, 1, 1.5944666529140512, -0.9692173129574591 };
    float b[] = { 1, -0.9852674718763040, 1, 1, -0.3678140918675017, 1, 1, 1.3541711838514376, 1, 1, -1.1713815107285585, 1 };
    // filter gains
    float gain_factor = 0.085667864748512997929985601786029292271 * 0.071984525012505143348739977682271273807 * 0.06414311970061792322894689277745783329 * 0.060572179183183680328816933524649357423;
    // filter response
    float res[DATA_LENGTH];

    // compute filter response
    elliptic(&res[0], &a[0], &b[0], gain_factor, PADDING, DATA_LENGTH);

    // expected (true) result
    float true_res[] = { 0.000024, 0.000131, 0.000449, 0.001190, 0.002645, 0.005129, 0.008886, 0.013952, 0.020026, 0.026398, 0.031986, 0.035517, 0.035822, 0.032192, 0.024681, 0.014245,
                            0.002635, -0.007959, -0.015441, -0.018380, -0.016428, -0.010463, -0.002369, 0.005483, 0.010903, 0.012515, 0.010130, 0.004754, -0.001765, -0.007350, -0.010356,
                            -0.010068, -0.006876, -0.002082, 0.002584, 0.005568, 0.006004, 0.003966, 0.000388, -0.003310, -0.005744, -0.006053, -0.004177, -0.000840, 0.002742, 0.005309,
                            0.006008, 0.004672, 0.001851, -0.001417, -0.003993, -0.005038, -0.004294, -0.002140, 0.000582, 0.002886, 0.004007, 0.003649, 0.002062, -0.000084, -0.001975,
                            -0.002951, -0.002740, -0.001524, 0.000156, 0.001628, 0.002349, 0.002098, 0.001040, -0.000364, -0.001545, -0.002055, -0.001731, -0.000739, 0.000501, 0.001493,
                            0.001859, 0.001479, 0.000529, -0.000599, -0.001459, -0.001721, -0.001302, -0.000382, 0.000665, 0.001429, 0.001618, 0.001170, 0.000274, -0.000715, -0.001413,
                            -0.001553, -0.001091, -0.000214, 0.000736, 0.001394, 0.001512, 0.001053, 0.000201, -0.000716, -0.001350, -0.001466, -0.001030, -0.000215, 0.000666, 0.001282,
                            0.001407, 0.001005, 0.000238, -0.000601, -0.001196, -0.001333, -0.000971, -0.000258, 0.000532, 0.001103, 0.001249, 0.000928, 0.000271, -0.000467, -0.001010,
                            -0.001162, -0.000878, -0.000277, 0.000408, 0.000920, 0.001074, 0.000824, 0.000277, -0.000356, -0.000835, -0.000988, -0.000768, -0.000270, 0.000312, 0.000758,
                            0.000906, 0.000712, 0.000258, -0.000276, -0.000689, -0.000831, -0.000657, -0.000243, 0.000247, 0.000629, 0.000762, 0.000605, 0.000227, -0.000223, -0.000575,
                            -0.000700, -0.000558, -0.000211, 0.000203, 0.000528, 0.000644, 0.000515, 0.000196, -0.000186, -0.000486, -0.000594, -0.000476, -0.000183, 0.000170, 0.000448,
                            0.000549, 0.000441, 0.000170, -0.000156, -0.000414, -0.000508, -0.000409, -0.000159, 0.000143, 0.000382, 0.000471, 0.000380, 0.000149, -0.000130, -0.000353,
                            -0.000436, -0.000353, -0.000141, 0.000118, 0.000325, 0.000404, 0.000329, 0.000133, -0.000107, -0.000300, -0.000374, -0.000306, -0.000125, 0.000097, 0.000276,
                            0.000346, 0.000285, 0.000118, -0.000087, -0.000254, -0.000321, -0.000265, -0.000112, 0.000079, 0.000234, 0.000296, 0.000246, 0.000105, -0.000071, -0.000215,
                            -0.000274, -0.000229, -0.000099, 0.000064, 0.000198, 0.000253, 0.000213, 0.000093, -0.000057, -0.000181, -0.000234, -0.000197, -0.000088, 0.000051, 0.000167,
                            0.000216, 0.000183, 0.000082, -0.000046, -0.000153, -0.000200, -0.000170, -0.000077, 0.000041, 0.000141, 0.000185, 0.000158, 0.000073, -0.000037, -0.000129,
                            -0.000171, -0.000146, -0.000068, 0.000033, 0.000119, 0.000158, 0.000136, 0.000064, -0.000030, -0.000109, -0.000146, -0.000126, -0.000060, 0.000027, 0.000101 };

    // test for pointwise equality with some error tolerance
    //      abs(res[i] - true_res[i]) < epsilon
    float epsilon = 0.000002;
    int pass = check_if_equal(res, true_res, DATA_LENGTH, epsilon);

    if (pass) {
        printf("Test Passed!");
    }
    else {
        printf("Test failed.... :(");
    }

    return 0;
}
